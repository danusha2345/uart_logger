# UART Logger

Пассивный логгер двунаправленного UART-обмена на базе Spotpear RP2350-Core-A. Перехватывает два направления UART (921600 бод) и пишет на SD-карту в бинарном формате.

## Схема подключения

```
  Устройство A                    Устройство B
  ┌──────────┐                    ┌──────────┐
  │       TX ├────────────────────┤ RX       │
  │          │    ┌───────────┐   │          │
  │          │    │  RP2350   │   │          │
  │          ├────┤ GPIO1 (RX)│   │          │
  │          │    │  UART0    │   │          │
  │       RX ├────────────────────┤ TX       │
  │          │    │           │   │          │
  │          │    ├───────────┤   │          │
  │          ├────┤ GPIO5 (RX)│   │          │
  │          │    │  UART1    │   │          │
  └──────────┘    └───────────┘   └──────────┘

  Line A: TX устройства A → подключить к GPIO1
  Line B: TX устройства B → подключить к GPIO5
```

**Важно**: логгер подключается **параллельно** к существующим линиям. Он только слушает (RX), не передаёт.

## Распиновка

### UART (пассивный перехват)

| Сигнал | GPIO | Подключение |
|--------|------|-------------|
| Line A | GPIO1 | TX устройства A (направление A→B) |
| Line B | GPIO5 | TX устройства B (направление B→A) |

GPIO0 и GPIO4 (TX) заняты HAL-ом, но физически не подключаются.

### SD-карта (SPI1)

| Сигнал | GPIO | SD-карта |
|--------|------|----------|
| SCK | GPIO10 | CLK |
| MOSI | GPIO11 | DI (CMD) |
| MISO | GPIO12 | DO (DAT0) |
| CS | GPIO13 | CS (DAT3) |
| 3.3V | — | VCC |
| GND | — | GND |

### LED (WS2812B)

| Сигнал | GPIO |
|--------|------|
| DIN | GPIO25 |

Встроенный на плате Spotpear RP2350-Core-A.

## LED индикация

| Цвет | Паттерн | Значение |
|------|---------|----------|
| Синий | Быстрое мигание | Инициализация |
| Красный | Медленное мигание | Ошибка SD-карты |
| Зелёный | Горит постоянно | Запись |
| Жёлтый | Мигание | Переполнение буфера (потеря пакетов) |

## Бинарный формат записи

Файлы: `LOG_0001.BIN`, `LOG_0002.BIN`, ... (автонумерация)

Каждая запись:

```
Offset  Size  Описание
0       1     Direction: 0x00 = Line A, 0x01 = Line B
1       4     Timestamp (мс от старта, little-endian)
5       2     Length (длина данных, little-endian)
7       N     Data (до 256 байт)
```

Пример (hexdump):
```
00 2A 00 00 00 05 00 48 65 6C 6C 6F    Line A, ts=42ms, 5 bytes: "Hello"
01 30 00 00 00 02 00 4F 4B              Line B, ts=48ms, 2 bytes: "OK"
```

## Сборка и прошивка

```bash
cargo build --release
cargo run --release      # прошивка через probe-rs
```

Требуется: Rust nightly, `probe-rs`, подключение через SWD.

## Подготовка SD-карты

- Формат: **FAT32** (FAT16 тоже поддерживается для карт ≤2 ГБ)
- Размер: до 128 ГБ (тестировалось на 2–64 ГБ)
- Вставить карту **до** включения питания

### Карты 64/128 ГБ (SDXC)

Карты SDXC (64 ГБ и выше) продаются с файловой системой exFAT, которая **не поддерживается** прошивкой. Перед использованием их нужно переформатировать в FAT32.

**Linux:**
```bash
# Определить устройство (например /dev/sdb)
lsblk

# Создать таблицу разделов и один раздел
sudo parted /dev/sdX mklabel msdos
sudo parted /dev/sdX mkpart primary fat32 1MiB 100%

# Форматировать в FAT32 (кластер 32 КБ — оптимально для последовательной записи)
sudo mkfs.fat -F 32 -s 64 /dev/sdX1
```

**Windows:**
- Стандартный форматтер Windows **не умеет** форматировать карты >32 ГБ в FAT32
- Использовать [Rufus](http://rufus.ie/) или [guiformat](http://ridgecrop.co.uk/index.htm?guiformat.htm)
- Выбрать: FAT32, размер кластера 32 КБ

**macOS:**
```bash
# Определить устройство (например /dev/disk4)
diskutil list

# Форматировать
sudo diskutil eraseDisk FAT32 SDCARD MBRFormat /dev/diskN
```
